# handle_dnanexus_email.py

## Objective
We would like to be able to automate the process of emailing a email notice (text file) generated by a DNAnexus applet. As of yet, there is no an easy way to send an email directly from an Applet. So, we developed a script run download the email notice and then to email it to the recipients. There are at least three requirements:
1. SMTP email capabilites via python [https://docs.python.org/3/library/smtplib.html](https://docs.python.org/3/library/smtplib.html).
2. Applet generates an email with a given syntax (example in section ***Email Syntax***) that is able to place the email in the following location in item 3 bellow.
3. A fixed location for each project: ***\<DNAnexus Project\>:/email/pending/\<Job-ID\>_notice.email.txt***

## Algoritm Overview
This script will have the following actions:
1. For a given project, the script will serach for files at location: ***\<DNAnexus Project\>:/email/\<Job-ID\>_notice.email.txt***
2. A cron job periodically runs *handle_dnanexus_email.py* which will have the following actions:
	1. Download email files from ***\<DNAnexus Project\>:/email/pending/\<Job-ID\>_notice.email.txt*** to ***Helix***.
	2. Move from ***\<DNAnexus Project\>:/email/pending\<Job-ID\>_notice.email.txt*** to ***\<DNAnexus Project\>:/email/sent/\<Job-ID\>_notice.email.txt***
	3. Email contents of ***\<Helix Sent Directory Location\>\\<Job-ID\>_notice.email.txt***
	4. Exit.

## Email Syntax
***\<Job-ID\>_notice.email.txt*** will have the following requirements:
```TEXT
Email To: thing1@gmail.com,thing2@gmail.com,thing3d@gmail.com
Subject: Some useful 1 line subject on line 2. >
Some useful email letter content of one or more lines.
```

## Get command-line help
```BASH
python3 handle_dnanexus_email.py --help
```

## Get version information
```BASH
python3 handle_dnanexus_email.py --version
```

## Creating test directories and test email files
Using a text editor generate a test email following the example in section above **Email Syntax**. Only files located on DNAnexus at location ***$DNANEXUS_PROJECT:/email/pending*** will be "operated" on. Additionally, generate the required directories at the root level using the ***dx mkdir*** as directed below:

```BASH
DNANEXUS_PROJECT=<Project Name or ID>
dx mkdir --parents $DNANEXUS_PROJECT:/email/pending
dx mkdir --parents $DNANEXUS_PROJECT:/email/sent
dx upload ../TestFiles/job-xxxx_notice.email.txt --destination=$DNANEXUS_PROJECT:/email/pending/job-xxxx_notice.email.txt
dx upload ../TestFiles/job-yyyy_notice.email.txt --destination=$DNANEXUS_PROJECT:/email/pending/job-yyyy_notice.email.txt
```
## Minimal run with option ***--no_downloads*** option.
This will simply list available files in directory ***$DNANEXUS_PROJECT:/email/pending*** on DNAnexus.
- ***--project_name*** (required) - DNAnexus Project name or Project ID.
- ***--no_downloads*** (optional) - No downloads, but files found on DNAnexus at location ***$DNANEXUS_PROJECT:/email/pending*** will be listed.
- No downloads take place.
- No emails are sent.

```BASH
python3 handle_dnanexus_email.py --project_name $DNANEXUS_PROJECT --no_downloads
```

## Full run example
Below is the best use case:
- ***--use_exclude_file*** (optional) start by providing an empty file and as files are downloaded, a list of file-id will be written and will prevent files from being downloaded again. You can create an empty file with the touch command.
- ***--send_email*** (optional) - An attempt to send out emails will be made. If used with  ***--no_downloads***, no emails will be sent.
- email messages on DNAnexus at location ***$DNANEXUS_PROJECT:/email/pending*** will be moved to ***$DNANEXUS_PROJECT:/email/sent***


```BASH
# Generate blank exclude file.
touch ./exclude.txt # if no existing exclude.txt file exists.
python3 handle_dnanexus_email.py \
--project_name $DNANEXUS_PROJECT \
--use_exclude_file ./exclude.txt \
--send_email test@gmail.com

# Check if emails are moved from 'pending' to 'sent' directory locations.
dx ls -l $DNANEXUS_PROJECT:/email/pending
dx ls -l $DNANEXUS_PROJECT:/email/sent
```
## Example of download email notice, but no email is sent.

```BASH
python3 handle_dnanexus_email.py --project_name $DNANEXUS_PROJECT
```
